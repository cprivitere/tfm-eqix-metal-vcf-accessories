## template: jinja
#cloud-config
hostname: bastion
package_update: true
package_upgrade: true
package_reboot_if_required: true
write_files:
- path: /etc/sysctl.d/10-ip-forwarding.conf
  content: |
    net.ipv4.ip_forward=1
- path: /etc/iptables/rules.v4
  content: |
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
    # Generated by iptables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *nat
    :PREROUTING ACCEPT [0:0]
    :INPUT ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    :POSTROUTING ACCEPT [0:0]
    -A POSTROUTING -o bond0 -j MASQUERADE
    COMMIT
    # Completed on Tue Aug 24 19:16:37 2021
- path: /etc/iptables/rules.v6
  content: |
    # Generated by ip6tables-save v1.8.4 on Tue Aug 24 19:16:37 2021
    *filter
    :INPUT ACCEPT [0:0]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [0:0]
    COMMIT
- path: /etc/network/interfaces
  append: true
  content: |
    auto bond0.${metal_vlan_id}
    iface bond0.${metal_vlan_id} inet static
        pre-up sleep 5
        address ${address}
        netmask ${netmask}
        gateway ${gateway_address}
        vlan-raw-device bond0
- path: /etc/dnsmasq.d/vcf.config
  append: true
  content: |
    host-record=sfo01-m01-esx01.sfo.rainpole.io,172.16.11.101
    host-record=sfo01-m01-esx02.sfo.rainpole.io,172.16.11.102
    host-record=sfo01-m01-esx03.sfo.rainpole.io,172.16.11.103
    host-record=sfo01-m01-esx04.sfo.rainpole.io,172.16.11.104
    host-record=sfo-m01-vc01.sfo.rainpole.io,172.16.11.62
    host-record=sfo-m01-nsx01.sfo.rainpole.io,172.16.11.65
    host-record=sfo-m01-nsx01a.sfo.rainpole.io,172.16.11.66
    host-record=sfo-m01-nsx01b.sfo.rainpole.io,172.16.11.67
    host-record=sfo-m01-nsx01c.sfo.rainpole.io,172.16.11.68
    host-record=sfo-vcf01.sfo.rainpole.io,172.16.11.59
- path: /etc/chrony/conf.d/vcf.conf
  append: true
  content: |
    allow all
- path: /etc/resolv.conf
  append: false
  content: |
    nameserver 127.0.0.1
    nameserver 147.75.207.207
    nameserver 147.75.207.208
    search sfo.rainpole.io
packages:
  - iptables-persistent
  - dnsmasq
  - chrony
runcmd:
- sysctl -p /etc/sysctl.d/10-ip-forwarding.conf
- systemctl disable systemd-resolved --now
- systemctl restart networking
- systemctl restart dnsmasq